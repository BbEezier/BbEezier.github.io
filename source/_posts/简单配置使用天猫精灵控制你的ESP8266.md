---
title: 简单配置使用天猫精灵控制你的ESP8266
author: yLTT
avatar: 'http://q1.qlogo.cn/g?b=qq&nk=309002093&s=640'
authorLink: 'https://www.liangzt.top'
authorAbout: 与君共勉!
authorDesc: 与君共勉!
categories: 技术
comments: true
tags:
  - 物联网
keywords: 'ESP8266,天猫精灵'
description: 简单上手天猫精灵实例
photos: 'https://api.amogu.cn/api/acg?=3'
abbrlink: 14312
date: 2021-09-14 08:30:20
---

## 简单配置使用<font color = #50C7D9>天猫精灵</font>控制你的<font color= #DC143C>ESP8266</font>!

好久不见，我是yLTT。好不容易进入高中阶段的最后一年，马上就能迎接新的生活了吧！

{% aplayer "義勇忍侠花吹雪" "田澤茉純 / 嘉山未紗 / 新田ひより" "http://music.163.com/song/media/outer/url?id=1346608352.mp3" "https://p1.music.126.net/ioELm7ZOPlUXYeKcnMjQQg==/109951163869439795.jpg?" %}

文章共分成4大块构成

- <a href="#bb1">阿里生活物联网平台配置</a>
- <a href="#bb2">硬件准备</a>
- <a href="#bb3">ESP8266代码</a>
- <a href="#bb4">Arduino代码</a>

#### <div id= bb1><font color = #40E0D0>阿里生活物联网平台</font>配置</div>

打开 **<font color =#00008d>[天猫精灵开放平台](https://www.aligenie.com/)</font>** 找到 **生活物联网平台**

<img src="1.png" data-action="zoom">

![2](2.png)

选择 **直连接入**

![3](3.png)

进入到阿里云生活物联网平台中的 **项目管理** 界面，我们新建一个项目，名字按自己需求自定义，其余选项保持默认

![4](4.png)

在产品管理界面中，我们新建一个产品。所属品类最好按你实际功能选择，因为如果瞎选的话，有一些用电器在天猫精灵里面是没有对应的操控方式的，天猫精灵适配的用电器可以在等下进入产品设置界面看到（~~大不了重新新建一个产品~~）

这里的连网方式我们要选为**蜂窝**网，因为如果选择wifi方式会要求你的芯片自行组网，如果你有这个需求可以在网上查询相关教程进行设置。一般个人用户做着玩的项目选蜂窝就足够了。

![5](5.png)

来到 **功能定义** 界面，在这里你可以使用 **标准功能** 或者自己自定义一个功能进行数据的交换，我嫌麻烦这部分就按默认的来了，大家按需选择

![6](6.png)

下一步我们来到人机交互界面，先把右上角的使用 **公版App控制产品 **勾选好，然后转到天猫精灵选项勾选开启，此时你也能看见 <font color = #00008d>**天猫精灵**</font> 支持控制的品类了，如果你的产品不在产品类别中那么请重新新建一个产品。 

其余的选项，大家自行设置完后记得要保存一下，要不然他会用 <font color = #FFA500>**! **</font>来警示你，强迫症看着还是很不爽的

![7](7.png)

转到 **设备调试** 界面，我们随便选一个芯片

![8](8.png)

然后我们 **新增测试设备** ,DeviceName你自己自定义，新建过后他会有三个数据（ProductKey、DeviceName、DeviceSecret）给你，最好拿txt文件保存一下方便等一下操作

至此，**生活物联网平台** 的设置暂时告一段落

#### <font color = #ff0070><div id= bb2>硬件准备</div></font>

![10](10.jpg)

首先，你得先有一个天猫精灵是吧~

![11](11.jpg)

这是我的nodemcu开发板

![12](12.jpg)

这是我的Arduino UNO和一个测试用的RGB模块

![9](9.png)

简单的接线图

#### <font color=#52ff00><div id= bb3>ESP8266代码</div></font>

首先要确保你的Arduino IDE有 [AliyunIoTSDK](https://github.com/yu-tou/arduino-aliyun-iot-sdk) 这个库，按照他的说明把依赖项安装好。

感谢芋头大佬，让ESP8266连上阿里云变得更加方便迅速

[ESP8266离线包](https://www.arduino.cn/thread-76029-1-1.html)

```c
// 引入 wifi 模块，并实例化，不同的芯片这里的依赖可能不同
#include <ESP8266WiFi.h>
static WiFiClient espClient;
// 引入阿里云 IoT SDK
#include <AliyunIoTSDK.h>
// 设置产品和设备的信息，从阿里云设备信息里查看
#define PRODUCT_KEY "a1aOFU668aC"                        //产品ID
#define DEVICE_NAME "FKRGB"                //设备名
#define DEVICE_SECRET "************" //设备key
#define REGION_ID "cn-shanghai"
// 设置 wifi 信息
#define WIFI_SSID "ESP8266"   
#define WIFI_PASSWD "IOT666666"
void setup()
{
    Serial.begin(115200);
    // 初始化 wifi
    wifiInit(WIFI_SSID, WIFI_PASSWD);
    // 初始化 iot，需传入 wifi 的 client，和设备产品信息
    AliyunIoTSDK::begin(espClient, PRODUCT_KEY, DEVICE_NAME, DEVICE_SECRET, REGION_ID); 
}

void loop()
{
     AliyunIoTSDK::loop();
}

// 初始化 wifi 连接
void wifiInit(const char *ssid, const char *passphrase)
{
    WiFi.mode(WIFI_STA);
    WiFi.begin(ssid, passphrase);
    while (WiFi.status() != WL_CONNECTED)
    {
        delay(1000);
        Serial.println("WiFi not Connect");
    }
    Serial.println("Connected to AP");
}
```

请用刚才你保存好的3个数据，替换上面的定义，还有wifi的设置也请你自行替换

烧录过后，应该就能看到你的设备已经在线了

![13](13.png)

这时我们先暂时回到 **生活物联网平台** 中的 **批量投产** 页面

![14](14.png)

点开配网 + App下载二维码 把你的Device Name填好生成二维码

确定好你的Esp8266已经连接好阿里云后，在手机上搜索应用商店下载 **云智能** APP

点开右上角的扫码功能，扫这个二维码

![17](17.jpg)

这是我配网成功的界面，我们现在打开Arduino IDE的串口功能，查看我们在App下达的指令 **ESP8266** 能否收到

![18](18.png)

欧耶！成功了！

这时我们可以对代码进行进一步的修改

```c
// 引入 wifi 模块，并实例化，不同的芯片这里的依赖可能不同
#include <ESP8266WiFi.h>
static WiFiClient espClient;
// 引入阿里云 IoT SDK
#include <AliyunIoTSDK.h>
#include<SoftwareSerial.h>
SoftwareSerial mySerial(4,5); //D2，D1脚分别为rx，tx
// 设置产品和设备的信息，从阿里云设备信息里查看
#define PRODUCT_KEY "a1aOFU668aC"                        //产品ID
#define DEVICE_NAME "FKRGB"                //设备名
#define DEVICE_SECRET "***************" //设备key
#define REGION_ID "cn-shanghai"
// 设置 wifi 信息
#define WIFI_SSID "ESP8266"   
#define WIFI_PASSWD "IOT666666"
int Red,Blue,Green;
String RGBvalue;
void setup()
{
    // set the digital pin as output:
    mySerial.begin(9600);
    Serial.begin(115200);
    // 初始化 wifi
    wifiInit(WIFI_SSID, WIFI_PASSWD);
    // 初始化 iot，需传入 wifi 的 client，和设备产品信息
    AliyunIoTSDK::begin(espClient, PRODUCT_KEY, DEVICE_NAME, DEVICE_SECRET, REGION_ID);
    // 绑定一个设备属性回调，当远程修改此属性，会触发 SetRGBColorCallback
    // RGBColor 是在设备产品中定义的功能标识符
    AliyunIoTSDK::bindData("RGBColor",SetRGBColorCallback);
}

void loop()
{
     AliyunIoTSDK::loop();
}

// 初始化 wifi 连接
void wifiInit(const char *ssid, const char *passphrase)
{
    WiFi.mode(WIFI_STA);
    WiFi.begin(ssid, passphrase);
    while (WiFi.status() != WL_CONNECTED)
    {
        delay(1000);
        Serial.println("WiFi not Connect");
    }
    Serial.println("Connected to AP");
}

// RGBColor状态修改的回调函数
void SetRGBColorCallback(JsonVariant p)
{
    Red = p["RGBColor"]["Red"];
    Green = p["RGBColor"]["Green"];
    Blue = p["RGBColor"]["Blue"];
    RGBvalue += Red;
    RGBvalue += ',';
    RGBvalue += Green;
    RGBvalue += ',';
    RGBvalue += Blue;
    mySerial.print(RGBvalue);
    Serial.print(RGBvalue);
    RGBvalue = "";
}
```

看注释就知道函数大概的用途，如果对上面函数有不了解的建议去看 AliyunIotSdk 的技术文档

然后我们回到 云智能App 来到这个页面点开 **更多服务**

![15](15.png)

找到天猫精灵，绑定你自己天猫精灵的账号

![16](16.jpg)

绑定成功后，打开天猫精灵看看

![19](19.jpg)

欧耶！连接上天猫精灵啦！

用天猫精灵控制esp8266就很简单了，我们直接呢，在场景这个选项当中，新建一个自定义智能场景即可

![20](20.jpg)

![21](21.jpg)

![22](22.jpg)

然后你只需要对天猫精灵喊命令，就会按你的设置执行功能了

#### <font color =#39c5bb><div id= bb4>Arduino代码</div></font>

```c
#include<SoftwareSerial.h>
SoftwareSerial mySerial(2,3); //2，3脚分别为rx，tx
#define Rpin 9
#define Gpin 10
#define Bpin 11
String ReadData;
int RGBvalue[]={0,0,0};
int tod;
int i = 0;
void setup()
{ 
  Serial.begin(115200);
  mySerial.begin(9600);
  pinMode(Rpin,OUTPUT);
  pinMode(Gpin,OUTPUT);
  pinMode(Bpin,OUTPUT);
}
void loop()
{
   SerialListen();
   goRGBwithArray(RGBvalue);
   i = 0;
   ReadData = "";
}
void SerialListen(){
   while(mySerial.available())
   {
     ReadData += char(mySerial.read());
     delay(2);
   }
   Serial.print(ReadData);
   do{
      tod = ReadData.indexOf(',');//找到字符串中逗号出现的位置
          if(tod != -1)
          {
             String str;//我们先创建一个String
             str = ReadData.substring(0,tod);//用来保存逗号前面的数据
             RGBvalue[i] = str.toInt();//将上面的保存好的String数据转换成Int类型保存到RGBvalue中
             ReadData = ReadData.substring(tod + 1,ReadData.length());
             i++;//进入下一次循环
           //  Serial.println(message);
          }
          else{
            if(ReadData.length()>0){
               RGBvalue[2] = ReadData.toInt();
            }
          }
     }while(tod>=0);
  }
void goRGB(int Rval,int Gval,int Bval){
  analogWrite(Rpin,Rval);
  analogWrite(Gpin,Gval);//因为我手头这个RGB灯带是共阴的，所以不需要用255去减，如果是共阴的RGB灯带要用255减去这个值
  analogWrite(Bpin,Bval);
  }
void goRGBwithArray(int RGBval[]){
  analogWrite(Rpin,RGBval[0]);
  analogWrite(Gpin,RGBval[1]);
  analogWrite(Bpin,RGBval[2]);
  }
void bln(int pin,int val){ //简单呼吸灯函数
  for(int i=0;i<val ; i++){
    analogWrite(pin,i);
    delay(2);
    }
  delay(1000);
  for(int i=255;i>0 ; i--){
    analogWrite(pin,i);
    delay(2);
    }
  }
```

这里的代码可以不用照抄，大家可以按自己需求写自己的下位机代码，我这里主要是提供一个思路

### 总结

比较容易上手的实用小项目，适合喜欢动手的小伙伴来体验物联网这一概念！

#### 最后,<font color=#39c5bb>**Excelsior**!</font>